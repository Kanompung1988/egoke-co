rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===================================
    // Helper Functions - Hierarchical Permissions
    // SuperAdmin > Admin > Staff > User
    // ===================================
    
    // ตรวจสอบว่าเป็น SuperAdmin (สิทธิ์สูงสุด)
    function isSuperAdmin() {
      return request.auth != null 
        && request.auth.token.email == 'thanaponchanal@gmail.com';
    }
    
    // ตรวจสอบว่าเป็น Admin หรือสูงกว่า (SuperAdmin > Admin)
    function isAdmin() {
      return request.auth != null 
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['superadmin', 'admin'];
    }
    
    // ตรวจสอบว่าเป็น Staff หรือสูงกว่า (SuperAdmin > Admin > Staff)
    function isStaff() {
      return request.auth != null 
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['superadmin', 'admin', 'staff'];
    }
    
    // ตรวจสอบว่าเป็น Register หรือสูงกว่า (SuperAdmin > Admin > Register)
    function isRegister() {
      return request.auth != null 
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['superadmin', 'admin', 'register'];
    }
    
    // Helper function: ตรวจสอบว่าเป็นเจ้าของ document
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // Helper function: ตรวจสอบว่า login แล้ว
    function isAuthenticated() {
      return request.auth != null;
    }

    // ===================================
    // Users Collection
    // ===================================
    match /users/{userId} {
      // อ่านได้: 
      // - ตัวเอง
      // - Staff ขึ้นไป (staff, admin, superadmin)
      // - Register (สำหรับเช็คเข้างาน)
      allow read: if isAuthenticated() && (isOwner(userId) || isStaff() || isRegister());
      
      // สร้างได้: เฉพาะตัวเอง (เมื่อ login ครั้งแรก)
      allow create: if isAuthenticated() && isOwner(userId);
      
      // แก้ไขได้:
      // - ตัวเอง (อนุญาตให้แก้ voteRights, voteHistory, points, updatedAt สำหรับโหวตและซื้อสิทธิ์)
      // - Register (แก้ได้เฉพาะ attendance สำหรับเช็คเข้างาน)
      // - Staff (แก้ได้เฉพาะ points, updatedAt สำหรับเพิ่มแต้ม)
      // - Admin ขึ้นไป (admin, superadmin) แก้ได้ทุกอย่าง
      allow update: if isAuthenticated() && (
        (isOwner(userId) && (
          // ✅ อนุญาตให้ user แก้ไขได้ แต่ห้ามแก้ role และ tickets
          !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'tickets'])
        ))
        || (isRegister() && 
         // ✅ Register แก้ได้เฉพาะ attendance และ updatedAt (สำหรับเช็คเข้างาน)
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['attendance', 'updatedAt']))
        || (isStaff() && 
         // ✅ Staff แก้ได้เฉพาะ points และ updatedAt (สำหรับเพิ่มแต้มให้ User)
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['points', 'updatedAt']))
        || isAdmin()
      );
      
      // ลบได้: เฉพาะ SuperAdmin
      allow delete: if isSuperAdmin();
      
      // ===================================
      // History Subcollection (ประวัติการหมุนวงล้อของผู้ใช้)
      // ===================================
      match /history/{historyId} {
        // อ่านได้: ตัวเอง หรือ Staff ขึ้นไป
        allow read: if isAuthenticated() && (isOwner(userId) || isStaff());
        
        // สร้างได้: ตัวเอง (บันทึกประวัติการหมุน)
        allow create: if isAuthenticated() && isOwner(userId);
        
        // แก้ไข: Staff ขึ้นไป (สำหรับเคลมรางวัล)
        // ลบ: Admin ขึ้นไป
        allow update: if isStaff() || isAdmin();
        allow delete: if isAdmin();
      }
    }

    // ===================================
    // Votes Collection (บันทึกการโหวต)
    // ===================================
    match /votes/{voteId} {
      // อ่านได้: 
      // - ตัวเอง (ดูโหวตของตัวเอง)
      // - Staff ขึ้นไป (ดูโหวตทั้งหมด)
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid 
        || isStaff()
      );
      
      // สร้างได้: ทุกคนที่ login (โหวต)
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid;
      
      // แก้ไข/ลบ: เฉพาะ Admin ขึ้นไป
      allow update, delete: if isAdmin();
    }

    // ===================================
    // Candidates Collection (ผู้สมัคร)
    // ===================================
    match /candidates/{candidateId} {
      // อ่านได้: ทุกคนที่ login แล้ว
      allow read: if isAuthenticated();
      
      // อัพเดทได้: ทุกคนที่ login (สำหรับเพิ่ม voteCount เวลาโหวต)
      // หรือ Admin สามารถแก้ isVisible, isActive ได้
      allow update: if isAuthenticated() && (
        // ✅ ถ้าแก้เฉพาะ voteCount และ updatedAt อนุญาตให้ทุกคนแก้ได้
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['voteCount', 'updatedAt'])
        || isAdmin() // Admin แก้ได้ทุกอย่าง (รวม isVisible, isActive)
      );
      
      // สร้าง/ลบ: เฉพาะ Admin ขึ้นไป
      allow create, delete: if isAdmin();
    }

    // ===================================
    // VoteSettings Collection (การตั้งค่าการโหวต)
    // ===================================
    match /voteSettings/{settingId} {
      // อ่านได้: ทุกคนที่ login แล้ว
      allow read: if isAuthenticated();
      
      // แก้ไข: เฉพาะ Admin ขึ้นไป (เปิด/ปิดการโหวต)
      allow create, update, delete: if isAdmin();
    }

    // ===================================
    // VoteCategories Collection
    // ===================================
    match /voteCategories/{categoryId} {
      // อ่านได้: ทุกคนที่ login แล้ว
      allow read: if isAuthenticated();
      
      // สร้าง/แก้ไข/ลบ: เฉพาะ Admin ขึ้นไป
      allow create, update, delete: if isAdmin();
    }

    // ===================================
    // UserVotes Collection (การโหวตของผู้ใช้)
    // ===================================
    match /userVotes/{voteId} {
      // อ่านได้: ตัวเอง หรือ Staff ขึ้นไป
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid 
        || isStaff()
      );
      
      // สร้างได้: ตัวเอง (userId ต้องตรงกับ auth.uid)
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid;
      
      // แก้ไข/ลบ: เฉพาะ Admin ขึ้นไป
      allow update, delete: if isAdmin();
    }

    // ===================================
    // Prizes Collection (รางวัลจากการหมุนวงล้อ)
    // ===================================
    match /prizes/{prizeId} {
      // อ่านได้: ทุกคนที่ login แล้ว
      allow read: if isAuthenticated();
      
      // สร้าง/แก้ไข/ลบ: เฉพาะ Admin ขึ้นไป
      allow create, update, delete: if isAdmin();
    }

    // ===================================
    // Tickets Collection (ตั๋วรางวัลจากการหมุนวงล้อ)
    // ===================================
    match /tickets/{ticketId} {
      // อ่านได้: 
      // - ตัวเอง (เจ้าของตั๋ว)
      // - Staff ขึ้นไป (สำหรับเคลมรางวัล)
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid 
        || isStaff()
      );
      
      // สร้างได้: ทุกคนที่ login (เมื่อหมุนวงล้อได้รางวัล)
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid;
      
      // แก้ไขได้:
      // - Staff ขึ้นไป (สำหรับเคลมรางวัล - แก้ claimed, claimedAt, claimedBy)
      allow update: if isStaff() && (
        // ✅ อนุญาตให้แก้เฉพาะ claimed, claimedAt, claimedBy
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['claimed', 'claimedAt', 'claimedBy'])
      );
      
      // ลบได้: เฉพาะ Admin ขึ้นไป
      allow delete: if isAdmin();
    }

    // ===================================
    // SpinHistory Collection (ประวัติการหมุนวงล้อ)
    // ===================================
    match /spinHistory/{historyId} {
      // อ่านได้: ตัวเอง หรือ Staff ขึ้นไป
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid 
        || isStaff()
      );
      
      // สร้างได้: ตัวเอง
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid;
      
      // แก้ไข/ลบ: เฉพาะ Admin ขึ้นไป
      allow update, delete: if isAdmin();
    }

    // ===================================
    // QRScans Collection (ประวัติการสแกน QR)
    // ===================================
    match /qrScans/{scanId} {
      // อ่านได้: Staff ขึ้นไป
      allow read: if isStaff();
      
      // สร้างได้: Staff ขึ้นไป (เมื่อสแกน QR)
      allow create: if isStaff();
      
      // แก้ไข/ลบ: เฉพาะ Admin ขึ้นไป
      allow update, delete: if isAdmin();
    }

    // ===================================
    // Settings Collection (การตั้งค่าระบบ)
    // ===================================
    match /settings/{settingId} {
      // อ่านได้: ทุกคนที่ login แล้ว
      allow read: if isAuthenticated();
      
      // แก้ไข: เฉพาะ Admin ขึ้นไป
      allow create, update, delete: if isAdmin();
    }

    // ===================================
    // VoteRightsPurchases Collection (ประวัติการซื้อสิทธิ์โหวต)
    // ===================================
    match /voteRightsPurchases/{purchaseId} {
      // อ่านได้: ตัวเอง หรือ Staff ขึ้นไป
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid 
        || isStaff()
      );
      
      // สร้างได้: ระบบเท่านั้น (ผ่าน transaction)
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid;
      
      // แก้ไข/ลบ: เฉพาะ Admin ขึ้นไป
      allow update, delete: if isAdmin();
    }

    // ===================================
    // ActivityLogs Collection (บันทึกกิจกรรมทั้งหมด)
    // ===================================
    match /activityLogs/{logId} {
      // อ่านได้: เฉพาะ SuperAdmin
      allow read: if isSuperAdmin();
      
      // สร้างได้: ทุกคนที่ login (ระบบสร้างอัตโนมัติ)
      allow create: if isAuthenticated();
      
      // แก้ไข/ลบ: เฉพาะ SuperAdmin
      allow update, delete: if isSuperAdmin();
    }

    // ===================================
    // WarpStatus Collection (สถานะระบบส่งวาป IG)
    // ===================================
    match /warpStatus/{statusId} {
      // อ่านได้: ทุกคนที่ login แล้ว (เพื่อเช็คว่าระบบเปิดหรือปิด)
      allow read: if isAuthenticated();
      
      // แก้ไข: เฉพาะ Admin ขึ้นไป (เปิด/ปิดระบบ, รีเซ็ตจำนวน)
      allow create, update: if isAdmin();
      
      // ลบ: เฉพาะ SuperAdmin
      allow delete: if isSuperAdmin();
    }

    // ===================================
    // Notifications Collection (การแจ้งเตือนสำหรับผู้ใช้)
    // ===================================
    match /notifications/{notificationId} {
      // อ่านได้: ทุกคนที่ login แล้ว
      allow read: if isAuthenticated();
      
      // สร้าง/แก้ไข/ลบ: เฉพาะผ่าน Admin Script (ไม่อนุญาตผ่าน Frontend)
      allow create, update, delete: if false;
    }

    // ===================================
    // Users SeenNotifications Subcollection
    // ===================================
    match /users/{userId}/seenNotifications/{notificationId} {
      // อ่าน/เขียนได้: เฉพาะเจ้าของ
      allow read, write: if isAuthenticated() && isOwner(userId);
    }

    // ===================================
    // Default: Block All (ถ้าไม่ตรงกฎข้างบน)
    // ===================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
